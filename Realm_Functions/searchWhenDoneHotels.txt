// This function is the endpoint's request handler.
exports = function(payload, response) {
   
   const postbody = EJSON.parse(payload.body.text())
   console.log("Payload--"+JSON.stringify(postbody));
    
    //{"address.coord":{$geoWithin: {$box: postbody.box}}},
        
   let term = {$or:[
        {"address.location.coordinates":{$geoWithin: {$box: postbody.box}}},
        {"bedrooms":{$eq: {$box: postbody.bedrooms}}},
        {"beds":{$eq:postbody.beds}},
        {"bathrooms":{$eq:postbody.bathrooms}},
        {"price":{$lte:postbody.price}}
      ]
    };
    

    // Querying a mongodb service:
    const collection = context.services.get("mongodb-atlas").db("sample_airbnb").collection("listingsAndReviews");
    let hotels = collection.find(term).toArray();
    
    //let resp = await collection.aggregate(pipeline);
    console.log("Response --"+JSON.stringify(hotels));
    if(hotels.length ==0){
      return "Sorry unable to get results";
    }
    //this is to format from ejson to regular json response
    response.setStatusCode(200);
    response.setHeader("Content-Type", "application/json");
    response.setBody(JSON.stringify(hotels));
    
    return response;
};
